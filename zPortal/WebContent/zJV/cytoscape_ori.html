<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>toolbar</title>
<link href="./css/bootstrap_3.3.6/bootstrap.min.css" rel="stylesheet">
<link href="./css/font-awesome-4.0.3/css/font-awesome.css" rel="stylesheet" type="text/css" />
<script src="./js/libs/jquery-2.1.4.min.js"></script>
<script src="./js/libs/cytoscape.min.js"></script>
<script type="text/javascript" src="./js/libs/bootstrap_3.3.6/bootstrap.min.js"></script>
<script src="./js/libs/cytoscape-cxtmenu.js"></script>

<!-- page style -->
<style>
body {
	font-family: helvetica;
	font-size: 14px;
}

#cy {
	width: 100%;
	height: 500px;
	background-color: #f9f9f9;
}

h1 {
	opacity: 0.5;
	font-size: 1em;
}

/* you can set the disabled style how you like on the text/icon */
.cxtmenu-disabled {
	opacity: 0.333;
}

/* navigation */
ul.nav-tabs {
	width: 140px;
	margin-top: 20px;
	border-radius: 4px;
	border: 1px solid #ddd;
	box-shadow: 0 1px 4px rgba(0, 0, 0, 0.067);
}

ul.nav-tabs li {
	margin: 0;
	border-top: 1px solid #ddd;
}

ul.nav-tabs li:first-child {
	border-top: none;
}

ul.nav-tabs li a {
	margin: 0;
	padding: 8px 16px;
	border-radius: 0;
}

ul.nav-tabs li.active a, ul.nav-tabs li.active a:hover {
	color: #fff;
	background: #0088cc;
	border: 1px solid #0088cc;
}

ul.nav-tabs li:first-child a {
	border-radius: 4px 4px 0 0;
}

ul.nav-tabs li:last-child a {
	border-radius: 0 0 4px 4px;
}

ul.nav-tabs.affix {
	top: 30px; /* Set the top position of pinned element */
}

/* defaults */
i {
	font-size: 1.5em;
}

</style>
</head>
<body data-spy="scroll" data-target="#tutorial-menu">
	<div id="cy" class="cy col-md-7 col-md-offset-1"></div>
</body>

<!-- cy outlook script -->
<script>
$(function() { // on dom ready
	
	//initial
	init();
});

function init(){
	getCytoscapeRootNode("#" , "교통안전공단", 0);
}


function getCytoscapeRootNode(rootId, rootName, depth) {
	var fullUrl = "/zPortal/visualization/cytoscape.do";

	$.ajax({
		url : fullUrl,
		type : "GET",
		data: {rootId:rootId,rootName:rootName,depth:depth},
        contentType: "application/json; charset=utf-8",
		dataType : 'json',
		beforeSend : function() {
		},
		success : function(data) {
	        var cy = window.cy = cytoscape({
	            container: document.getElementById('cy'),
	
	            ready: function () {
	               
	            },
	
	            style: [
	                {
	                    selector: 'node',
	                    css: {
	                    	'content' : 'data(name)',
							'text-valign' : 'center',
							'color' : 'white',
							'text-outline-width' : 4,
							'text-outline-color' : '#999',
							'width' : 40,
							'height' : 40
	                    }
	                },
	
	                {
	                    selector: 'edge',
	                    css: {
	                        'line-color' : '#888',
	                        'target-arrow-color' : '#333',
							'source-arrow-color' : '#333',
							'target-arrow-shape': 'triangle',
	                        'width' : 2,
	                    }
	                },
	
	                // custom classes
	                {
	                    selector: '.selected-node',
	                    css: {
	                        'border-color': '#f00',
	                        'border-width': '2px'
	                    }
	                },
	                {
	                    selector: '.tool-node',
	                    css: {
	                        'font-family': 'FontAwesome',
	                        'font-size': '3em',
	                    }
	                },
	                {
	                    selector: '.node-start',
	                    css: {
	                        'content': '\uf090'
	                    }
	                },
	                {
	                    selector: '.node-end',
	                    css: {
	                        'content': '\uf011'
	                    }
	                },
	                {
	                    selector: '.node-condition',
	                    css: {
	                        'content': '\uf0e8'
	                    }
	                },
// 	                {
// 	                    selector: '.node-result',
// 	                    css: {
// 	                        'content': '\uf24a'
// 	                    }
// 	                },
	                {
	                    selector: '.node-processing',
	                    css: {
	                        'content': '\uf085'
	                    }
	                },
// 	                {
// 	                    selector: '.node-extract',
// 	                    css: {
// 	                        'content': '\uf1fb'
// 	                    }
// 	                },
// 	                {
// 	                    selector: '.node-storeDatabase',
// 	                    css: {
// 	                        'content': '\uf1c0'
// 	                    }
// 	                },
	                {
						selector : '.NodeClass1',
						style : {
							'shape' : 'roundrectangle',
							'text-valign' : 'top',
							'background-color' : '#ccc',
							'background-opacity' : 0.333,
							'color' : '#888',
							'text-outline-width' : 0,
							'font-size' : 25
						}
					},

					{
						selector : '.NodeClass2',
						style : {
							'shape' : 'roundrectangle',
							'text-valign' : 'top',
							'background-color' : '#ccc',
							'background-opacity' : 0.333,
							'color' : '#888',
							'text-outline-width' : 0,
							'font-size' : 25
						}
					},

					{
						selector : '.NodeClass3',
						style : {
							'shape' : 'roundrectangle',
							'text-valign' : 'top',
							'background-color' : '#ccc',
							'background-opacity' : 0.333,
							'color' : '#888',
							'text-outline-width' : 0,
							'font-size' : 25
						}
					},
					{
						selector : '#rootNode',
						style : {
							'background-opacity' : 0,
							'border-width' : 1,
							'border-color' : '#aaa',
							'border-opacity' : 0.5,
							'font-size' : 50,
							'padding-top' : 40,
							'padding-left' : 40,
							'padding-bottom' : 40,
							'padding-right' : 40
						}
					}
	            ],
	
	            elements : jQuery.parseJSON(data),
	        });
	
	        //#endregion
	        cy.cxtmenu({
				selector : 'node',

				commands : [ {
					content : '루트로 열기',
					select : function() {
						getCytoscapeRootNode(this.id() , this.data('name'), 0);
					}
				},{
					content : '처음으로',
					select : function() {
						init();
					}
				},
				{
					content : '열기',
					select : function() {
						
					}
				},
				{
					content : '닫기',
					select : function() {
						
					}
				}
				,
				{
					content : '닫기12',
					select : function() {
						
					}
				}
				,
				{
					content : '보고서로이동',
					select : function() {
						document.location.href("http://www.naver.com");
					}
				}]
			});

			var options = {
				name : 'cose',
				// Called on `layoutready`
				ready : function() {
				},
				// Called on `layoutstop`
				stop : function() {
				},
				// Whether to animate while running the layout
				animate : true,
				// The layout animates only after this many milliseconds
				// (prevents flashing on fast runs)
				animationThreshold : 250,
				// Number of iterations between consecutive screen positions update
				// (0 -> only updated on the end)
				refresh : 20,
				// Whether to fit the network view after when done
				fit : true,
				// Padding on fit
				padding : 30,
				// Constrain layout bounds; { x1, y1, x2, y2 } or { x1, y1, w, h }
				boundingBox : undefined,
				// Extra spacing between components in non-compound graphs
				componentSpacing : 100,
				// Node repulsion (non overlapping) multiplier
				nodeRepulsion : function(node) {
					return 400000;
				},
				// Node repulsion (overlapping) multiplier
				nodeOverlap : 10,
				// Ideal edge (non nested) length
				idealEdgeLength : function(edge) {
					return 10;
				},
				// Divisor to compute edge forces
				edgeElasticity : function(edge) {
					return 100;
				},
				// Nesting factor (multiplier) to compute ideal edge length for nested edges
				nestingFactor : 5,
				// Gravity force (constant)
				gravity : 80,
				// Maximum number of iterations to perform
				numIter : 1000,
				// Initial temperature (maximum node displacement)
				initialTemp : 200,
				// Cooling factor (how the temperature is reduced between consecutive iterations
				coolingFactor : 0.95,
				// Lower temperature threshold (below this point the layout will end)
				minTemp : 1.0,
				// Whether to use threading to speed up the layout
				useMultitasking : true
			};

			//	 				var options = {
			//	 				  name: 'breadthfirst',

			//	 				  fit: true, // whether to fit the viewport to the graph
			//	 				  directed: false, // whether the tree is directed downwards (or edges can point in any direction if false)
			//	 				  padding: 30, // padding on fit
			//	 				  circle: false, // put depths in concentric circles if true, put depths top down if false
			//	 				  spacingFactor: 1.75, // positive spacing factor, larger => more space between nodes (N.B. n/a if causes overlap)
			//	 				  boundingBox: undefined, // constrain layout bounds; { x1, y1, x2, y2 } or { x1, y1, w, h }
			//	 				  avoidOverlap: true, // prevents node overlap, may overflow boundingBox if not enough space
			//	 				  roots: undefined, // the roots of the trees
			//	 				  maximalAdjustments: 0, // how many times to try to position the nodes in a maximal way (i.e. no backtracking)
			//	 				  animate: false, // whether to transition the node positions
			//	 				  animationDuration: 500, // duration of animation in ms if enabled
			//	 				  animationEasing: undefined, // easing of animation if enabled
			//	 				  ready: undefined, // callback on layoutready
			//	 				  stop: undefined // callback on layoutstop
			//	 				};

			cy.layout(options);
		},
		error : function(request, status, error) {
			alert("code:" + request.status + "\n" + "message:" + request.responseText + "\n" + "error:" + error);
		}

	});
}

//#region node tools
function addStartToGraph(e) {
    addObject(e, addStartToGraph);
}

function addendToGraph(e) {
    addObject(e, addendToGraph);
}

function addConditionToGraph(e) {
    addObject(e, addConditionToGraph);
}

function addResultToGraph(e) {
    addObject(e, addResultToGraph);
}

function addProcessingToGraph(e) {
    addObject(e, addProcessingToGraph);
}

function addExtractToGraph(e) {
    addObject(e, addExtractToGraph);
}

function addStoreDatabaseToGraph(e) {
    addObject(e, addStoreDatabaseToGraph);
}

function addAssetToGraph(e) {
    addObject(e, addAssetToGraph);
}

function addObject(e, action) {
    if (!e.data.canPerform(e, action)) {
        return;
    }

    var toolIndexes = e.data.data.selectedTool;
    var tool = e.data.data.options.tools[toolIndexes[0]][toolIndexes[1]];

    var object = {
        group: 'nodes',
        data: {
            name: tool.options.text
        },
        position: {
            x: e.cyPosition.x,
            y: e.cyPosition.y
        }
    }

    e.cy.add(object).addClass('tool-node').addClass(tool.options.clazz);
}
//#endregion

//#region linking
var src;
function performLink(e) {
    if (!e.data.canPerform(e, performLink)) {
        return;
    }

    if (src) {
        tgt = e.cyTarget;

        e.cy.add({
            group: "edges",
            data: {
                source: src.id(),
                target: tgt.id()
            }
        });

        src.removeClass('selected-node');
        src = undefined;
    } else {
        src = e.cyTarget;
        src.addClass('selected-node');
    }
}

function getLinkName(src, tgt) {
    return src.id() + "->" + tgt.id();
}
//#endregion

//#region Remove
function performRemove(e) {
    if (!e.data.canPerform(e, performRemove)) {
        return;
    }

    cy.remove(e.cyTarget);
}
</script>

</html>
